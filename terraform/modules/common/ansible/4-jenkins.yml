- hosts: master
  become: yes
  tasks:
  - name: Create Jenkins namespace
    become: yes
    become_user: ubuntu
    shell: kubectl create namespace jenkins || true

  - name: Apply Jenkins Deployment
    become: yes
    become_user: ubuntu
    copy:
      content: |
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: jenkins
          labels:
            app: jenkins
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: jenkins
          template:
            metadata:
              labels:
                app: jenkins
            spec:
              containers:
              - name: jenkins
                image: jenkins/jenkins:lts
                ports:
                - containerPort: 8080
                - containerPort: 50000
      dest: /tmp/jenkins_deployment.yml

  - name: Deploy Jenkins Deployment
    become: yes
    become_user: ubuntu
    shell: kubectl apply -f /tmp/jenkins_deployment.yml --namespace=jenkins

  - name: Apply Jenkins Services
    become: yes
    become_user: ubuntu
    copy:
      content: |
        apiVersion: v1
        kind: Service
        metadata:
          name: jenkins
        spec:
          type: NodePort
          ports:
            - port: 8080
              targetPort: 8080
              nodePort: 30000
          selector:
            app: jenkins
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: jenkins-jnlp
        spec:
          type: ClusterIP
          ports:
            - port: 50000
              targetPort: 50000
          selector:
            app: jenkins
      dest: /tmp/jenkins_service.yml

  - name: Deploy Jenkins Services
    become: yes
    become_user: ubuntu
    shell: kubectl apply -f /tmp/jenkins_service.yml --namespace=jenkins

  - name: Wait for Jenkins to be deployed
    become: yes
    become_user: ubuntu
    shell: kubectl rollout status deployment/jenkins --namespace=jenkins
